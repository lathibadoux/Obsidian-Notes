[[#002.3.2.1 Steps to build the query]]
[[#002.3.2.2 Cons of this query]]
## 002.3.2.1 Steps to build the query

1. Create table for slowly changing dimension
```sql
create table players_scd (  
    player_name TEXT,  
    scoring_class scoring_class,  
    is_active boolean,  
    start_season integer,  
    end_season integer,  
    current_season integer, -- Think about this as the date partition of the table.  Usually last column  
    primary key(player_name, start_season)  
)
```

2. Using the transaction table, find the previous values for the dimension
```sql
with with_previous as (  
    select  
        player_name,  
        current_season,  
        scoring_class,  
        is_active,  
        lag(scoring_class, 1)  
            over (partition by player_name order by current_season) as previous_scoring_class,  
        lag(is_active, 1)  
            over (partition by player_name order by current_season) as previous_is_active  
    from players
    where current_season <= 2021 -- think of this as a parameter that would be manually populated when the query is execut
),
```

|                |                |               |           |                        |                    |
| -------------- | -------------- | ------------- | --------- | ---------------------- | ------------------ |
| player_name    | current_season | scoring_class | is_active | previous_scoring_class | previous_is_active |
| Michael Jordan | 1996           | star          | TRUE      | null                   | null               |
| Michael Jordan | 1997           | star          | TRUE      | star                   | TRUE               |
| Michael Jordan | 1998           | star          | FALSE     | star                   | TRUE               |
| Michael Jordan | 1999           | star          | FALSE     | star                   | FALSE              |
| Michael Jordan | 2000           | star          | FALSE     | star                   | FALSE              |
| Michael Jordan | 2001           | star          | TRUE      | star                   | FALSE              |
| Michael Jordan | 2002           | good          | TRUE      | star                   | TRUE               |
| Michael Jordan | 2003           | good          | FALSE     | good                   | TRUE               |
| Michael Jordan | 2004           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2005           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2006           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2007           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2008           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2009           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2010           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2011           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2012           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2013           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2014           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2015           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2016           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2017           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2018           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2019           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2020           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2021           | good          | FALSE     | good                   | FALSE              |
| Michael Jordan | 2022           | good          | FALSE     | good                   | FALSE              |

3. Next create an indicator to identify when dimension changes based on the previous value columns
```sql
with_indicators as (  
    select  
        *,  
        case  
            -- want to sum the change_indicator so you can keep track of the streaks  
            when scoring_class <> previous_scoring_class then 1  
            when is_active <> previous_is_active then 1  
            else 0  
        end as change_indicator  
    from with_previous  
),
```
```csvtable
source: with_indicators_output.csv
```



4. Next calculate the streaks by adding up the change_indicator column
```sql
with_streaks as (  
    select  
        *,  
        -- looking at how long this will stay the same value  
        sum(change_indicator)  
            over (partition by player_name order by current_season) as streak_identifier  
    from with_indicators  
)

```
```csvtable
source: with_streaks_output.csv
```





5. Collapse the streak by pivoting on start and end dates
```sql
select  
    player_name,  
    streak_identifier,  
    is_active,  
    scoring_class,  
    min(current_season) as start_season,  
    max(current_season) as end_season,
    2021 as current_season -- think of this as a parameter that would be manually populated when the query is execut  
from with_streaks  
group by player_name, streak_identifier, is_active, scoring_class
```

```csvtable
source: collapsed_streaks_output.csv
```

6. Insert this query into the players_scd table

## 002.3.2.2 Cons of this query
1. There's a lot of window functions which have to be performed on the entire dataset.  It's only at the end that you do the group by to shrink the data.  You can do this kind of thing because dimensional data just isn't that big.
2. Going to be a lot more prone to "out of memory" exceptions and skew.