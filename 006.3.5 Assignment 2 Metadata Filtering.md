
## Assignment Instructions

In this weeks homework, you will be processing some classical books into a structure and vectors for easier retrieval

In this repo: https://github.com/DataExpert-io/ai-application-october-2025 you will find a homework folder where the books are located.

You need to do the following things:

- Update your rag_content table to contain the appropriate metadata filtering (e.g. document id, chapter title, paragraph number). Include this SQL file in the submission
    
- Add a script that chunks and loads the book content into Postgres including the correct metadata filtering
    
- Update main.py to pull the right metadata information either as input UI (think buttons) or with AI (similar to how we did it in the lab) Zip up these three files and submit!

---
## AI Feedback

### üß© 1) Updated `rag_content` Schema with Metadata Filtering Fields

**What you submitted**

- `rag_content table structure.txt` shows:  
    `embedding`, `user_id`, `chapter_number`, `paragraph_number`, `id`, `creator`, `book_title`, `chapter_title`, `username`, `context`, `document_type`, `document_id`
    
- `week2_update_rag_content.sql` adds `document_id`, `creator`, `book_title`, `chapter_title`, `chapter_number`, `paragraph_number`
    
- `week2_assignment_indices.sql` creates indexes for `document_type`, `creator`, `book_title`, `document_id`, `chapter_number`, `paragraph_number`
    

**Evaluation**

- ‚úÖ All required metadata fields present: `creator`, `book_title`, `chapter_title`, `chapter_number`, `paragraph_number`, `document_id`, `document_type`
    
- ‚úÖ SQL function `match_documents_by_document_types_array` supports optional filters for each field
    
- ‚úÖ Embedding column dimension (`vector(1536)`) matches `text-embedding-3-small`
    

**Suggestions**

- Add `IF NOT EXISTS` to migration for idempotency
    
    `ALTER TABLE rag_content ADD COLUMN IF NOT EXISTS creator text;`
    
- Ensure `pgvector` extension is installed
    
    `CREATE EXTENSION IF NOT EXISTS vector; ALTER TABLE rag_content ALTER COLUMN embedding TYPE vector(1536);`
    
- Add vector index for performance (optional but recommended):
    
    `CREATE INDEX IF NOT EXISTS idx_rag_content_embedding   ON rag_content USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);`
    
- Consider an index on `chapter_title` if frequently filtered
    

---

### üßÆ 2) Python Loader (`week2_load_embeddings.py`)

**What you submitted**

- Parses Gutenberg HTML, extracts metadata, chunks by paragraph, creates OpenAI embeddings (`text-embedding-3-small`), and upserts into `rag_content`
    

**Evaluation**

- ‚úÖ End-to-end loader works correctly (HTML ‚Üí metadata ‚Üí embedding ‚Üí DB)
    
- ‚úÖ Embedding dimension consistent with `vector(1536)`
    
- ‚úÖ Deterministic ID generation and metadata population
    

**Suggestions**

- Add simple retry for transient OpenAI/Supabase errors
    
- Confirm IDs are unique per paragraph (you‚Äôre already using `ebook_url-counter`)
    
- Handle alternate chapter HTML structures defensively
    

---

### ‚öôÔ∏è 3) FastAPI Server (`week2_main.py`)

**What you submitted**

- Classifies `document_type(s)` via OpenAI
    
- Extracts metadata filters (`book_title`, `creator`, `chapter_number`, `chapter_title`, `document_id`, `paragraph_number`)
    
- Determines `top-k` dynamically
    
- Generates query embedding
    
- Calls RPC `match_documents_by_document_types_array` with embedding + filters
    
- Optionally reranks via GPT
    
- Returns answer and RAG results
    

**Evaluation**

- ‚úÖ Filters passed to RPC correctly ‚Äî meets ‚Äúfilters metadata correctly‚Äù requirement
    
- ‚úÖ Returns similarity and metadata, orders by cosine distance
    

**Suggestions**

- Equality filters (`=`) require exact string matches. Consider:
    
    - Normalizing (casing/punctuation), or
        
    - Using `ILIKE` / trigram similarity for titles and authors
        
- Ensure numeric filters (`chapter_number`, etc.) are integers before RPC call
    
- Replace deprecated `gpt-3.5-turbo` with `gpt-4o-mini` for speed/consistency
    
- Return clearer RPC error messages for debugging
    

---

### üß± Notable Issues

- `week2_supabase_lib.py` contains an unused helper referencing a non-existent RPC (`match_documents_by_document_type` singular).  
    Remove or fix it to prevent confusion.
    
- Minor naming inconsistency: `match_content` ‚Üí `match_count`
    
- Add vector index for performance as dataset grows
    

---

### üìã What to Provide if Re-checked

- Full DDL for `rag_content`, including embedding column type and dimension
    
- SQL used to create pgvector extension and index
    
- Confirmation that `gpt-4o-mini` replaces `gpt-3.5-turbo` if needed
    
- Optional: updated user-level filtering (`user_id` or `username`)
    

---

### üèÅ Final Verdict

‚úÖ All deliverables implemented correctly  
‚ö†Ô∏è One minor bug in unused helper (should be removed or renamed)  
üí° Improvements mostly around performance and resilience

**Final Grade:**

`{   "letter_grade": "A",   "passes": true }`