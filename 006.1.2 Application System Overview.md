

```lua
+-----------------+           +----------------+           +------------------+
|  Frontend (UI)  |  HTTP     |   FastAPI app  |  Python   |   OpenAI (API)   |
|  (templates/*)  +----------->  (main.py)     +----------->  (embeddings/LLM)|
+-----------------+           +----------------+           +------------------+
                                  |   ^
                                  v   |
                           +----------------+      Pub/Sub
                           |  Supabase      |<----------------+
                           |  (Postgres)    |                 |
                           |  - tables      |                 |
                           |    rag_content |                 |
                           |    resumes     |                 |
                           |    resume_job  |                 |
                           |  - RPC funcs   |                 |
                           |    match_*     |                 |
                           +----------------+                 |
                                   ^                         |
                                   |                         |
                                   +-------------------------+
                                                PubNub
```

### Diagram of `api/chat`code path with line-of-though

```sql
User message
   │
   ├─ classify_document_type()      ← OpenAI (decides ['job'] / ['profile'] / ['book'] / all)
   │
   ├─ determine_optimal_top_k()     ← OpenAI (returns k ~ 3..20)
   │
   ├─ embeddings.create()           ← OpenAI (vectorize query)
   │
   ├─ query_rag_content_many_types()← SUPABASE RPC (vector search by type(s))
   │
   ├─ rerank_results_gpt()          ← OpenAI (order results by relevance)
   │
   └─ chat.completions.create()     ← OpenAI (compose final answer with context)
        ↓
      JSON response
```

### Main Request Flows

1) **`/api/chat`** (RAG chat w/ classification → embedding → RPC → rerank → answer)

```sql
[HTTP POST /api/chat]
   └─> classify_document_type(user_message)        (OpenAI chat)
   └─> determine_optimal_top_k(user_message)       (OpenAI chat)
   └─> embedding_response = openai.embeddings      (OpenAI embeddings)
   └─> query_rag_content_many_types(..., doc_types)  <-- SUPABASE RPC CALL
   └─> rerank_results_gpt(..., results)            (OpenAI chat)
   └─> final completion with context               (OpenAI chat)
   └─> return response
```

2) **`/api/parse-resume-with-matching`** (Parse → embed → two RPC searches → insert into `resume_jobs` table)

```sql
[HTTP POST /api/parse-resume-with-matching]
   └─> parse resume via OpenAI tools               (OpenAI chat)
   └─> embedding_response = openai.embeddings      (OpenAI embeddings)
   └─> jobs   = query_rag_content(..., 'job')      <-- SUPABASE RPC CALL
   └─> profile= query_rag_content(..., 'profile')  <-- SUPABASE RPC CALL
   └─> insert_resume(resume_json)                  (Supabase .table insert)
   └─> return matched snippets + parsed resume
```

3) **`/api/parse-resume-with-matching-pubnub`** (enqueue job via PubNub, insert into `resume_jobs` table)

```sql
[HTTP POST /api/parse-resume-with-matching-pubnub]
   └─> insert_resume_job({...})                    (Supabase .table insert)
   └─> pubnub_client.publish(channel, job_id)      (PubNub)
   └─> return job id
```

4) **`/api/parse-resume`** (Parse → insert into `resume_jobs` table)

```sql
[HTTP POST /api/parse-resume]
   └─> parse resume via OpenAI tools               (OpenAI chat)
   └─> insert_resume(resume_json)                  (Supabase .table insert)
   └─> return parsed resume
```
